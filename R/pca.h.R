
# This file is automatically generated, you probably don't want to edit this

#' @importFrom jmvcore Options
#' @importFrom R6 R6Class
pcaOptions <- R6::R6Class(
    "pcaOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            nFactorMethod = "parallel",
            nFactors = 1,
            minEigen = 1,
            rotation = "varimax",
            hideLoadings = 0.3,
            screePlot = FALSE,
            eigenValues = FALSE,
            factorCor = FALSE, ...) {

            super$initialize(
                package='jmv',
                name='pca',
                requiresData=TRUE,
                ...)
        
            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "ordinal",
                    "continuous"),
                permitted=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                rejectInf=FALSE)
            private$..nFactorMethod <- jmvcore::OptionList$new(
                "nFactorMethod",
                nFactorMethod,
                options=list(
                    "parallel",
                    "eigen",
                    "fixed"),
                default="parallel")
            private$..nFactors <- jmvcore::OptionInteger$new(
                "nFactors",
                nFactors,
                min=1,
                default=1)
            private$..minEigen <- jmvcore::OptionNumber$new(
                "minEigen",
                minEigen,
                default=1)
            private$..rotation <- jmvcore::OptionList$new(
                "rotation",
                rotation,
                options=list(
                    "none",
                    "varimax",
                    "quartimax",
                    "promax",
                    "oblimin",
                    "simplimax",
                    "cluster"),
                default="varimax")
            private$..hideLoadings <- jmvcore::OptionNumber$new(
                "hideLoadings",
                hideLoadings,
                default=0.3)
            private$..screePlot <- jmvcore::OptionBool$new(
                "screePlot",
                screePlot,
                default=FALSE)
            private$..eigenValues <- jmvcore::OptionBool$new(
                "eigenValues",
                eigenValues,
                default=FALSE)
            private$..factorCor <- jmvcore::OptionBool$new(
                "factorCor",
                factorCor,
                default=FALSE)
        
            self$.addOption(private$..vars)
            self$.addOption(private$..nFactorMethod)
            self$.addOption(private$..nFactors)
            self$.addOption(private$..minEigen)
            self$.addOption(private$..rotation)
            self$.addOption(private$..hideLoadings)
            self$.addOption(private$..screePlot)
            self$.addOption(private$..eigenValues)
            self$.addOption(private$..factorCor)
        }),
    active = list(
        vars = function() private$..vars$value,
        nFactorMethod = function() private$..nFactorMethod$value,
        nFactors = function() private$..nFactors$value,
        minEigen = function() private$..minEigen$value,
        rotation = function() private$..rotation$value,
        hideLoadings = function() private$..hideLoadings$value,
        screePlot = function() private$..screePlot$value,
        eigenValues = function() private$..eigenValues$value,
        factorCor = function() private$..factorCor$value),
    private = list(
        ..vars = NA,
        ..nFactorMethod = NA,
        ..nFactors = NA,
        ..minEigen = NA,
        ..rotation = NA,
        ..hideLoadings = NA,
        ..screePlot = NA,
        ..eigenValues = NA,
        ..factorCor = NA)
)

#' @import jmvcore
#' @importFrom R6 R6Class
pcaResults <- R6::R6Class(
    inherit = jmvcore::Group,
    active = list(
        loadings = function() private$..loadings,
        eigen = function() private$..eigen,
        factorCor = function() private$..factorCor,
        screePlot = function() private$..screePlot),
    private = list(
        ..loadings = NA,
        ..eigen = NA,
        ..factorCor = NA,
        ..screePlot = NA),
    public=list(
        initialize=function(options) {
            super$initialize(options=options, name="", title="Principal Component Analysis")
            private$..loadings <- jmvcore::Table$new(
                options=options,
                name="loadings",
                title="Component Loadings",
                rows="(vars)",
                clearWith=list(
                    "vars",
                    "nFactorMethod",
                    "nFactors",
                    "hideLoadings",
                    "rotation"),
                columns=list(
                    list(`name`="name", `title`="", `type`="text", `content`="($key)"),
                    list(`name`="pc1", `title`="1", `type`="number", `superTitle`="Component"),
                    list(`name`="uniq", `title`="Uniqueness", `type`="number")))
            private$..eigen <- jmvcore::Table$new(
                options=options,
                name="eigen",
                title="Eigenvalues",
                visible="(eigenValues)",
                clearWith=list(
                    "vars",
                    "nFactorMethod",
                    "nFactors",
                    "rotation"),
                columns=list(
                    list(`name`="comp", `title`="Component", `type`="text"),
                    list(`name`="eigen", `title`="Eigenvalue", `type`="number", `superTitle`="Initial Eigenvalues"),
                    list(`name`="varProp", `title`="% of Variance", `type`="number", `superTitle`="Initial Eigenvalues"),
                    list(`name`="varCum", `title`="Cumalitive %", `type`="number", `superTitle`="Initial Eigenvalues"),
                    list(`name`="eigenSS", `title`="Eigenvalue", `type`="number", `superTitle`="Sum of Squared Loadings"),
                    list(`name`="varPropSS", `title`="% of Variance", `type`="number", `superTitle`="Sum of Squared Loadings"),
                    list(`name`="varCumSS", `title`="Cumalitive %", `type`="number", `superTitle`="Sum of Squared Loadings")))
            private$..factorCor <- jmvcore::Table$new(
                options=options,
                name="factorCor",
                title="Component Correlation Matrix",
                visible="(factorCor)",
                clearWith=list(
                    "vars",
                    "nFactorMethod",
                    "nFactors",
                    "hideLoadings",
                    "rotation"),
                columns=list(
                    list(`name`="comp", `title`="", `type`="text", `format`="narrow"),
                    list(`name`="pc1", `title`="1", `type`="number")))
            private$..screePlot <- jmvcore::Image$new(
                options=options,
                name="screePlot",
                title="Scree Plot",
                visible="(screePlot)",
                width=500,
                height=300,
                renderFun=".screePlot",
                clearWith=list(
                    "vars",
                    "screePlot",
                    "nFactorMethod",
                    "minEigen"))
            self$add(private$..loadings)
            self$add(private$..eigen)
            self$add(private$..factorCor)
            self$add(private$..screePlot)}))

#' @importFrom jmvcore Analysis
#' @importFrom R6 R6Class
pcaBase <- R6::R6Class(
    "pcaBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = 'jmv',
                name = 'pca',
                version = c(1,0,0),
                options = options,
                results = pcaResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE)
        }))

#' Principal Component Analysis
#'
#' 
#'
#' @examples
#' \dontrun{
#' pca(data, vars = c('x1', 'x2', 'x3'))
#' }
#' @param data .
#' @param vars a vector of strings naming the variables of interest in 
#'   \code{data}
#' @param nFactorMethod \code{'parallel'} (default), \code{'eigen'} or 
#'   \code{'fixed'}, the way to determine the number of factors 
#' @param nFactors an integer (default: 1), the number of components in the 
#'   model 
#' @param minEigen a number (default: 1), the minimal eigenvalue for a 
#'   component to be included in the model 
#' @param rotation \code{'none'}, \code{'varimax'} (default), 
#'   \code{'quartimax'}, \code{'promax'}, \code{'oblimin'} \code{'simplimax'} or 
#'   \code{'cluster'}, the rotation to use in estimation 
#' @param hideLoadings a number (default: 0.8), hide loadings below 
#' @param screePlot \code{TRUE} or \code{FALSE} (default), show scree plot 
#' @param eigenValues \code{TRUE} or \code{FALSE} (default), show eigenvalue 
#'   table 
#' @param factorCor \code{TRUE} or \code{FALSE} (default), show factor 
#'   correlations 
#' @export
pca <- function(
    data,
    vars,
    nFactorMethod = "parallel",
    nFactors = 1,
    minEigen = 1,
    rotation = "varimax",
    hideLoadings = 0.3,
    screePlot = FALSE,
    eigenValues = FALSE,
    factorCor = FALSE) {

    options <- pcaOptions$new(
        vars = vars,
        nFactorMethod = nFactorMethod,
        nFactors = nFactors,
        minEigen = minEigen,
        rotation = rotation,
        hideLoadings = hideLoadings,
        screePlot = screePlot,
        eigenValues = eigenValues,
        factorCor = factorCor)

    results <- pcaResults$new(
        options = options)

    analysis <- pcaClass$new(
        options = options,
        data = data)

    analysis$run()
    analysis$render()

    analysis$results
}
